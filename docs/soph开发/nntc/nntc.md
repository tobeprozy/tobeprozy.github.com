---
title: nntcå¼€å‘
article: true
date: 2023-04-27
category:
  - å·¥ä½œç¬”è®°
tag:
  - nntc
  - ç®—èƒ½
order: 
icon: ğŸ§‘
---

::: tip
nntc
:::


## åŸºæœ¬æ¦‚å¿µ

nntcæ˜¯ä¸€ä¸ªç¥ç»ç½‘ç»œç¼–è¯‘å™¨ï¼Œå¯ä»¥å°†ç¥ç»ç½‘ç»œæ¨¡å‹è½¬æ¢ä¸ºç‰¹å®šç¡¬ä»¶å¹³å°ä¸Šå¯æ‰§è¡Œçš„ä»£ç ã€‚

ä½ éœ€è¦ç†Ÿæ‚‰nntcæ”¯æŒçš„æ¨¡å‹æ ¼å¼ï¼ˆå¦‚ONNXã€TensorFlowã€PyTorchç­‰ï¼‰ï¼Œä»¥åŠå¦‚ä½•å°†æ¨¡å‹è½¬æ¢ä¸ºç‰¹å®šç¡¬ä»¶çš„æŒ‡ä»¤é›†ã€‚

## åº”ç”¨ç§»æ¤çš„æµç¨‹

- æ¨¡å‹ç¼–è¯‘é‡åŒ–-nntcå·¥å…·

- åº”ç”¨å¼€å‘éƒ¨ç½²-libsophone

  ![image-20230427171334081](./photo/image-20230427171334081.png)

**åŸºæœ¬æµç¨‹ï¼š**

å…¶å®ƒæ¨¡å‹---->ç”ŸæˆBMODEL----->åŠ è½½BMODEL---->å‰å¤„ç†----->æ¨ç†------åå¤„ç†------>ç¼–è¯‘åº”ç”¨----->æ‰“åŒ…

### æ¨¡å‹çš„ç¼–è¯‘é‡åŒ–

**ä¸€ã€FP32 BMDELç”Ÿæˆ**ï¼Œä¹Ÿå°±æ˜¯å°†åŸå§‹æ¨¡å‹ç›´æ¥è½¬åŒ–ä¸ºä¸åŸå§‹æ¨¡å‹ç²¾åº¦ä¸€è‡´çš„å¯ä»¥è¿è¡Œåœ¨TPUä¸Šçš„æ¨¡å‹

**äºŒã€é‡åŒ– BMODEL ç”Ÿæˆ**ï¼Œæ ¹æ®éœ€æ±‚ä¿®æ”¹æ¨¡å‹ï¼š

å¦‚æœ FP32 ä¸èƒ½æ»¡è¶³æ€§èƒ½éœ€æ±‚ï¼Œéœ€è¦å¯¹æ¨¡å‹è¿›è¡Œé‡åŒ–, é‡åŒ–åæ¨¡å‹ç²¾åº¦ä¼šæœ‰ä¸€å®šæŸå¤±ï¼Œä½†èƒ½å……
åˆ†å‘æŒ¥èŠ¯ç‰‡ç®—åŠ›ã€‚

**ç¬¬ä¸€æ­¥ï¼š**å‡†å¤‡é‡åŒ–ç”¨çš„è¾“å…¥æ•°æ®é›†ï¼Œæ¯”å¦‚åŒ…å«è¾“å…¥å›¾ç‰‡çš„æ–‡ä»¶å¤¹

**ç¬¬äºŒæ­¥ï¼š**é‡åŒ–ï¼š

â€‹			**ï¼ˆ1ï¼‰è‡ªåŠ¨é‡åŒ–ï¼š**åˆ©ç”¨åŸå§‹æ¨¡å‹å’Œæ•°æ®é›†ç›´æ¥ç”Ÿæˆé‡åŒ–BMODELï¼Œå³ï¼ˆ1ï¼‰ï¼ˆ3ï¼‰---->ï¼ˆ4ï¼‰

â€‹				**ä¼˜ç‚¹ï¼š**æ­¥éª¤ç®€å•ã€å‚æ•°è‡ªåŠ¨æœç´¢

â€‹				ç¼ºç‚¹ï¼šæ—¶é—´æ¯”è¾ƒé•¿ã€æ€§èƒ½ä¸ä¸€å®šæ˜¯æœ€ä¼˜çš„ã€‚

â€‹			**ï¼ˆ2ï¼‰åˆ†æ­¥é‡åŒ–**ï¼šå¯¹åº”äºæ­¥éª¤ (5)(6)(7)(8)ã€‚å…¶ä¸­é‡ç‚¹æ˜¯æ­¥éª¤ (7) é‡åŒ–è°ƒå‚ï¼Œéœ€è¦ä¸€å®šçš„æŠ€å·§å’Œç»éªŒã€‚

**æ³¨æ„ä¸¤ä¸ªMODELï¼š**

ï¼ˆ1ï¼‰BMODEL æ˜¯ç”¨äºè®¾å¤‡åŠ è½½è¿è¡Œçš„ã€‚æ‰€æœ‰ç±»å‹çš„æ¨¡å‹è½¬æ¢æˆ BMODEL æ‰èƒ½åœ¨è®¾å¤‡ä¸Šè¿è¡Œã€‚

ï¼ˆ2ï¼‰UMODEL æ˜¯ç”¨äºé‡åŒ–çš„ä¸­é—´æ¨¡å‹ã€‚å¯ç”±åŸå§‹æ¨¡å‹å¯¼å‡º FP32 çš„ UMODELï¼Œç»è¿‡é‡åŒ–åä¼šç”Ÿæˆ INT8 çš„ UMODELï¼Œæœ€ç»ˆä¹Ÿä¼šè½¬æ¢æˆ BMODEL åˆ°è®¾å¤‡ä¸Šè¿è¡Œã€‚

## ä¾‹å­resnet18

### ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡åŸå§‹æ¨¡å‹

é“¾æ¥ï¼š[SOPHGO](http://219.142.246.77:65000/sharing/NVUS3acJ7)

- **ä¸‹è½½åˆ°æœ¬åœ° resnet18_classify.tar.gzï¼Œå¹¶è§£å‹ï¼š**
  ```tar zxvf resnet18_classify.tar.gz```

resnet18_classify ç›®å½•ä¸­åŒ…å«ä»¥ä¸‹æ–‡ä»¶ï¼š
Â· model/resnet18.onnx resnet18 åŸå§‹æ¨¡å‹
Â· images/ æµ‹è¯•å›¾ç‰‡é›†
Â· ILSVRC2012/ é‡åŒ–ç”¨æ•°æ®é›†
Â· scripts/ æœ¬ç¤ºä¾‹ä¸­è„šæœ¬æ–‡ä»¶
Â· src/ åº”ç”¨æºç ç›®å½•
Â· CMakeLists.txt æ„å»ºè„šæœ¬

### ç¬¬äºŒæ­¥ï¼šåˆå§‹åŒ–tpn-nntcç¯å¢ƒ

```bash
# å°†å½“å‰ç”¨æˆ·åŠ å…¥ docker ç»„
sudo usermod -aG docker $USER
newgrp docker

mkdir tpu-nntc
# å°†å‹ç¼©åŒ…è§£å‹åˆ°tpu-nntc
tar zxvf tpu-nntc_vx.y.z-<hash>-<date>.tar.gz --strip-components=1 -C tpu-nntc

# è¿›å…¥dockerï¼Œå¦‚æœå½“å‰ç³»ç»Ÿæ²¡æœ‰å¯¹åº”é•œåƒï¼Œä¼šè‡ªåŠ¨ä»docker hubä¸Šä¸‹è½½
cd tpu-nntc
docker run -v $PWD/..:/workspace -p 8001:8001 -it sophgo/tpuc_dev:latest
# æ­¤æ—¶å·²ç»è¿›å…¥dockerï¼Œå¹¶åœ¨/workspaceç›®å½•ä¸‹
# ä¸‹é¢åˆå§‹åŒ–è½¯ä»¶ç¯å¢ƒ
cd /workspace/tpu-nntc
source scripts/envsetup.sh

# ç¯å¢ƒåˆå§‹åŒ–å®Œæˆåï¼Œè¿›å…¥ resnet18_classify ç›®å½•
cd /workspace/resnet18_classify
# ä¸ºäº†æ–¹ä¾¿æ¸…ç†ï¼Œå»ºè®®åˆ›å»ºä¸€ä¸ªç©ºçš„å·¥ä½œç›®å½•
mkdir -p workdir && cd workdir
```

### ç¬¬ä¸‰æ­¥ï¼šç¼–è¯‘FP32BMODEL

è½¬æ¢çš„æ˜¯ onnx æ¨¡å‹ï¼Œæ‰€ä»¥éœ€è¦ bmneto å‰ç«¯(æ„æ€å°±è¯´onnex æ¨¡å‹è½¬æ¢åˆ°bmæ¨¡å‹)

```
# æ­¤æ—¶åœ¨resnet18_classify/workdirç›®å½•ä¸­
python3 -m bmneto --model ../model/resnet18.onnx \
--input_names "input" \
--shapes "[[1,3,224,224]]" \
--target BM1684X \
--outdir bmodel/fp32
```

å¯ä»¥è¾“å…¥æŸ¥çœ‹ä¸‹ fp32 bmodel çš„ä¿¡æ¯ï¼š

```
tpu_model --info bmodel/fp32/compilation.bmodel
```

### è‡ªåŠ¨é‡åŒ–ç”Ÿæˆ INT8 BMODEL

**è‡ªåŠ¨é‡åŒ–å·¥å…·**ä¼š**è‡ªåŠ¨**å¤„ç†**å›¾ç‰‡æ•°æ®é›†** å°†å…¶è½¬ä¸º **lmdb æ•°æ®é›†**ï¼Œå¹¶ä½¿ç”¨ä¸åŒé‡åŒ–ç­–ç•¥é‡åŒ–å¤šæ¬¡ï¼Œè‡ªåŠ¨ç”Ÿæˆ bmodelã€‚

```bash
# é‡åŒ–é‡‡ç”¨ ILSVRC2012 çš„éƒ¨åˆ†å›¾ç‰‡
# æ³¨æ„cali_image_preprocesså‚æ•°ï¼Œè¦å’Œæ¨¡å‹åŸå§‹åº”ç”¨çš„é¢„å¤„ç†ä¸€è‡´
# å¦åˆ™ä¼šå‡ºç°æ¨¡å‹é‡åŒ–ç²¾åº¦é«˜ï¼Œä½†åœ¨åº”ç”¨ä¸Šç²¾åº¦ä½çš„æƒ…å†µ
python3 -m ufw.cali.cali_model \
--net_name "resnet18" \
--model ../model/resnet18.onnx \
--cali_image_path ../ILSVRC2012/ \
--cali_image_preprocess '
resize_h=224,resize_w=224;
mean_value=123.675:116.28:103.53;
scale=0.0171:0.0175:0.0174;
bgr2rgb=True' \
--input_names 'input' \
--input_shapes '[1,3,224,224]' \
--target BM1684X \
--outdir auto_cali_out
cp -r auto_cali_out/resnet18_batch1 bmodel/auto-int8
```

æŸ¥çœ‹ä¸‹ bmodel çš„ä¿¡æ¯ï¼š

```bash
tpu_model --info bmodel/auto-int8/compilation.bmodel
```

æŸ¥çœ‹é‡åŒ–ç²¾åº¦æƒ…å†µ(å¯é€‰)

```bash
#åœ¨æœ¬æœºçš„ 8001 ç«¯å£ (å¯åŠ¨ docker æ—¶æ˜¾ç¤ºçš„ç«¯å£) å¯ä»¥æ‰“å¼€ç½‘é¡µï¼Œå¦‚æœæ˜¯æœ¬æœºç›´æ¥æ‰“å¼€http://localhost:8001 ï¼Œå¦‚æœæ˜¯è¿œç¨‹æœåŠ¡å™¨è¯·å°† localhost æ›¿æ¢æˆæœåŠ¡å™¨ IP
python3 -m ufw.tools.app --port 8001
```

**æ³¨æ„ï¼š**è¿™é‡Œå¯è§†åŒ–å·¥å…·æ˜¯åœ¨é‡åŒ–æ•°æ®é›†ä¸­éšæœºæ‰¾ä¸€å¼ å›¾è¿›è¡Œä¸€æ¬¡æ¨ç†ï¼Œå¹¶æŠŠæ•°æ®æ˜¾ç¤ºå‡ºæ¥ã€‚æ¯
æ¬¡æ˜¾ç¤ºæ—¶ä¼šä¸ä¸€æ ·ï¼Œä½†æ¯”è¾ƒæ¥è¿‘ã€‚

å¦‚æœæœ€ç»ˆç²¾åº¦æˆ–åœ¨ä¸šåŠ¡ä¸ŠéªŒè¯ç²¾åº¦ä¸æ»¡è¶³è¦æ±‚ï¼Œå¯ä»¥è€ƒè™‘å¢åŠ è¿­ä»£æ¬¡æ•°æˆ–å…¶ä»–å‚æ•°ã€‚

å›åˆ°å¼€å‘ç¯å¢ƒï¼ŒCtrl+C ç»“æŸç²¾åº¦æ˜¾ç¤ºæœåŠ¡ã€‚

